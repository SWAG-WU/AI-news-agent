# ============================================================
# AI 资讯收集 Agent - GitHub Actions 定时任务
# ============================================================
# 功能：每天北京时间 9:00 自动采集 AI 前沿资讯并推送到飞书
# ============================================================

name: AI Daily News Collector

on:
  # 定时触发：每天 UTC 1:00 = 北京时间 9:00
  schedule:
    - cron: '0 1 * * *'

  # 允许手动触发（用于测试）
  workflow_dispatch:

jobs:
  collect-news:
    name: 采集并推送 AI 资讯
    runs-on: ubuntu-latest

    # 超时设置（避免任务卡死）
    timeout-minutes: 30

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. 安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install openai

      # 4. 创建必要的目录
      - name: 创建目录
        run: |
          mkdir -p data
          mkdir -p logs

      # 5. 运行 AI 资讯收集
      - name: 运行 AI 资讯收集
        env:
          # ========== 飞书配置 ==========
          # 飞书机器人 Webhook URL（必需）
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          # 飞书签名验证密钥（可选，增强安全性）
          FEISHU_WEBHOOK_SECRET: ${{ secrets.FEISHU_WEBHOOK_SECRET }}

          # ========== LLM API 配置 ==========
          # 注意：项目使用智谱 AI（通过 OpenAI 兼容接口），不是 Claude
          # API Key（必需）
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # API Base URL（必需，智谱 AI: https://open.bigmodel.cn/api/paas/v4/）
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          # 模型名称（必需，如: glm-4-flash）
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

          # ========== GitHub 配置 ==========
          # GitHub Token（可选，用于访问 GitHub API 提高 rate limit）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # ========== 其他配置 ==========
          TZ: Asia/Shanghai
          LOG_LEVEL: INFO
        run: python main.py --once

      # 6. 上传日志文件（方便调试）
      - name: 上传日志
        if: always()  # 无论成功失败都上传
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: logs/
          retention-days: 7  # 保留 7 天

      # 7. 上传数据库（可选，用于历史记录）
      - name: 上传数据库
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: database-${{ github.run_number }}
          path: data/history.db
          retention-days: 30
